# DB 导数模块



#### 每月定时导数

1. 时间：cron = 0 0 3 6 * ?
2. 流程
   1. 分布式锁：确保分布式环境下任务只会在一个实例中运行
   2. 加载基础数据到 Redis
   3. 重新计算保存的规划值（每月新的数据刷新后保存的规划值需要重新计算）
   4. 邮件通知用户数据更新及规划值更新
3. 加载基础数据
   1. 数据详情：三级机构及销售总个数为 500 个左右
   2. 每个机构数据条数约为 20 万
      1. 其中产品 5 万、绩优 5w
      2. 产品 50000 = 险种 34 * 指标6 * 月份（1-24） * 司龄17
      3. 绩优数据 5w = 佣金 3 * 业务来源 3 * 绩优级别 10 * 司龄4 * 职级 3 * 指标 3 * 月份（1-24）
   3. 产品 Redis 结构
      1. string
      2. 数据层级：依次分指标 6 * 月份（1-24） * 司龄17
      3. key 数量大小 = 险种数



#### 保存规划值

1. 模糊匹配机构 Redis 数据（机构编码：用户 ID*）返回 redis key Set
2. 将 set 包装为 ArrayList作为 Redis multiGet 的入参
3. multiGet的反参和保证的key list 的按顺序一一对应
4. 遍历组装为机构数据保存对象（机构编码，业务编码，数据）的 list
5. mybatis inset foreach 到 PG 库中



#### 每月定时对比保存规划值系数

1. 时间：cron = 0 0 18 5 * ?
2. 流程
   1. 分布式锁
   2. 遍历机构列表：分机构对比
   3. 初始化一份默认的对比模板（相比保存的规划值、模板数据的规划值系数都为 1）
   4. 分模块对比（人力、产品、客户、绩优）
   5. 产品对比
      1. 分险种遍历
      2. 获取数据模板中数据+保存的 PG 库中数据
      3. 分指标
      4. 分司龄、分月份
      5. 优化（为防止调参次数过多，一年以内司龄系数相同设置调参坐标为一年以内而非 0-12月都调参，其他司龄累计类似优化）
      6. 调参坐标：月份、目标规划值、系数=目标/参考值、参考值
      7. 对比不同的调参坐标列表存储到 Redis 中
      8. 调用 function 模块中的调参接口调整模板得到新的规划值，保存到 PG 库中